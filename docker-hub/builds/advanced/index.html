<!-- Page generated 2020-07-16 21:49:37 +0900 -->
<!-- Logic for 'edit this button'


    

    

    

    

    

    

    

    

-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style type="text/css">
      @charset "UTF-8";
      [ng\:cloak],
      [ng-cloak],
      [data-ng-cloak],
      [x-ng-cloak],
      .ng-cloak,
      .x-ng-cloak,
      .ng-hide:not(.ng-hide-animate) {
          display: none !important;
      }

      ng\:form {
          display: block;
      }
  </style>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WL2QLG5');</script>

  
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <!-- metadata -->
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2020-07-16T21:49:37+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:domain" content="docs.docker.com"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:title" itemprop="title name" content="Advanced options for Autobuild and Autotest"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="The following options allow you to customize your automated build and automated test processes. Environment variables for building and testing Several utility environment variables are set by the build process,..." />
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="article:published_time" itemprop="datePublished" content="2020-07-16T21:49:37+09:00"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="automated, build, images">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link id="pygments" rel="stylesheet" href="/docs.docker.jp.onthefly/css/pygments/perldoc.css">
  <link id="pagestyle" rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css">

  <!-- Go get "Open Sans" font from Google -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <!-- SEO stuff -->
  <title>Advanced options for Autobuild and Autotest | Docker ドキュメント</title>
  <meta property="og:title" content="Advanced options for Autobuild and Autotest" />
  <meta property="og:locale" content="ja_JP" />
  <meta name="description" content="Automated builds" />
  <meta property="og:description" content="Automated builds" />
  <link rel="canonical" href="/docker-hub/builds/advanced/" />
  <meta property="og:url" content="https://docs.docker.com/docker-hub/builds/advanced/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebPage","headline":"Advanced options for Autobuild and Autotest","description":"Automated builds","url":"https://docs.docker.com/docker-hub/builds/advanced/"}</script>
  <!-- END SEO STUFF -->
  
</head>


    <body ng-app="Docker" ng-controller="DockerController" class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs">
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs">
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div id="tabs">
        <ul class="tabs jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>

        </div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section">
                            
                            
                            <h1>Advanced options for Autobuild and Autotest</h1> 
                            <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    5 分
  
</span>

                            
                            <p>The following options allow you to customize your automated build and automated test processes.</p>

<h2 id="environment-variables-for-building-and-testing">Environment variables for building and testing</h2>

<p>Several utility environment variables are set by the build process, and are
available during automated builds, automated tests, and while executing
hooks.</p>

<blockquote>
  <p><strong>Note</strong>: These environment variables are only available to the build and test
processes and do not affect your service’s run environment.</p>
</blockquote>

<ul>
  <li><code class="highlighter-rouge">SOURCE_BRANCH</code>: the name of the branch or the tag that is currently being tested.</li>
  <li><code class="highlighter-rouge">SOURCE_COMMIT</code>: the SHA1 hash of the commit being tested.</li>
  <li><code class="highlighter-rouge">COMMIT_MSG</code>: the message from the commit being tested and built.</li>
  <li><code class="highlighter-rouge">DOCKER_REPO</code>: the name of the Docker repository being built.</li>
  <li><code class="highlighter-rouge">DOCKERFILE_PATH</code>: the dockerfile currently being built.</li>
  <li><code class="highlighter-rouge">DOCKER_TAG</code>: the Docker repository tag being built.</li>
  <li><code class="highlighter-rouge">IMAGE_NAME</code>: the name and tag of the Docker repository being built. (This variable is a combination of <code class="highlighter-rouge">DOCKER_REPO</code>:<code class="highlighter-rouge">DOCKER_TAG</code>.)</li>
</ul>

<p>If you are using these build environment variables in a
<code class="highlighter-rouge">docker-compose.test.yml</code> file for automated testing, declare them in your <code class="highlighter-rouge">sut</code>
service’s environment as shown below.</p>

<pre><code class="language-none">sut:
  build: .
  command: run_tests.sh
  environment:
    - SOURCE_BRANCH
</code></pre>

<h2 id="override-build-test-or-push-commands">Override build, test or push commands</h2>

<p>Docker Hub allows you to override and customize the <code class="highlighter-rouge">build</code>, <code class="highlighter-rouge">test</code> and <code class="highlighter-rouge">push</code>
commands during automated build and test processes using hooks. For example, you
might use a build hook to set build arguments used only during the build
process. (You can also set up <a href="#custom-build-phase-hooks">custom build phase hooks</a> to perform actions in between these commands.)</p>

<p><strong>Use these hooks with caution.</strong> The contents of these hook files replace the
basic <code class="highlighter-rouge">docker</code> commands, so you must include a similar build, test or push
command in the hook or your automated process does not complete.</p>

<p>To override these phases, create a folder called <code class="highlighter-rouge">hooks</code> in your source code
repository at the same directory level as your Dockerfile. Create a file called
<code class="highlighter-rouge">hooks/build</code>, <code class="highlighter-rouge">hooks/test</code>, or <code class="highlighter-rouge">hooks/push</code> and include commands that the
builder process can execute, such as <code class="highlighter-rouge">docker</code> and <code class="highlighter-rouge">bash</code> commands (prefixed appropriately with <code class="highlighter-rouge"><span class="c">#!/bin/bash</span></code>).</p>

<h2 id="custom-build-phase-hooks">Custom build phase hooks</h2>

<p>You can run custom commands between phases of the build process by creating
hooks. Hooks allow you to provide extra instructions to the autobuild and
autotest processes.</p>

<p>Create a folder called <code class="highlighter-rouge">hooks</code> in your source code repository at the same
directory level as your Dockerfile. Place files that define the hooks in that
folder. Hook files can include both <code class="highlighter-rouge">docker</code> commands, and <code class="highlighter-rouge">bash</code> commands as long as they are prefixed appropriately with <code class="highlighter-rouge"><span class="c">#!/bin/bash</span></code>. The builder executes the commands in the files before and after each step.</p>

<p>The following hooks are available:</p>

<ul>
  <li><code class="highlighter-rouge">hooks/post_checkout</code></li>
  <li><code class="highlighter-rouge">hooks/pre_build</code></li>
  <li><code class="highlighter-rouge">hooks/post_build</code></li>
  <li><code class="highlighter-rouge">hooks/pre_test</code></li>
  <li><code class="highlighter-rouge">hooks/post_test</code></li>
  <li><code class="highlighter-rouge">hooks/pre_push</code> (only used when executing a build rule or <a href="/docs.docker.jp.onthefly/docker-hub/builds/">automated build</a> )</li>
  <li><code class="highlighter-rouge">hooks/post_push</code> (only used when executing a build rule or <a href="/docs.docker.jp.onthefly/docker-hub/builds/">automated build</a> )</li>
</ul>

<h3 id="build-hook-examples">Build hook examples</h3>

<h4 id="override-the-build-phase-to-set-variables">Override the “build” phase to set variables</h4>

<p>Docker Hub allows you to define build environment variables either in the hook files, or from the automated build interface (which you can then reference in hooks).</p>

<p>In the following example, we define a build hook that uses <code class="highlighter-rouge">docker build</code> arguments to set the variable <code class="highlighter-rouge">CUSTOM</code> based on the value of variable we defined using the Docker Hub build settings. <code class="highlighter-rouge">$DOCKERFILE_PATH</code> is a variable that we provide with the name of the Dockerfile we wish to build, and <code class="highlighter-rouge">$IMAGE_NAME</code> is the name of the image being built.</p>

<pre><code class="language-none">docker build --build-arg CUSTOM=$VAR -f $DOCKERFILE_PATH -t $IMAGE_NAME .
</code></pre>

<blockquote>
  <p><strong>Caution</strong>: A <code class="highlighter-rouge">hooks/build</code> file overrides the basic <a href="/engine/reference/commandline/build/">docker build</a> command
used by the builder, so you must include a similar build command in the hook or
the automated build fails.</p>
</blockquote>

<p>To learn more about Docker build-time variables, see the <a href="/engine/reference/commandline/build/#set-build-time-variables-build-arg">docker build documentation</a>.</p>

<h4 id="two-phase-build">Two-phase build</h4>

<p>If your build process requires a component that is not a dependency for your application, you can use a pre-build hook (refers to the <code class="highlighter-rouge">hooks/pre_build</code> file) to collect and compile required components. In the example below, the hook uses a Docker container to compile a Golang binary that is required before the build.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"=&gt; Building the binary"</span>
docker run <span class="nt">--privileged</span> <span class="se">\</span>
  <span class="nt">-v</span> <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/src <span class="se">\</span>
  <span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="se">\</span>
  centurylink/golang-builder
</code></pre></div></div>

<h4 id="push-to-multiple-repos">Push to multiple repos</h4>

<p>By default the build process pushes the image only to the repository where the build settings are configured. If you need to push the same image to multiple repositories, you can set up a <code class="highlighter-rouge">post_push</code> hook to add additional tags and push to more repositories.</p>

<pre><code class="language-none">docker tag $IMAGE_NAME $DOCKER_REPO:$SOURCE_COMMIT
docker push $DOCKER_REPO:$SOURCE_COMMIT
</code></pre>

<h2 id="source-repository--branch-clones">Source Repository / Branch Clones</h2>

<p>When Docker Hub pulls a branch from a source code repository, it performs
a shallow clone (only the tip of the specified branch).  This has the advantage
of minimizing the amount of data transfer necessary from the repository and
speeding up the build because it pulls only the minimal code necessary.</p>

<p>Because of this, if you need to perform a custom action that relies on a different
branch (such as a <code class="highlighter-rouge">post_push</code> hook), you can’t checkout that branch, unless
you do one of the following:</p>

<ul>
  <li>
    <p>You can get a shallow checkout of the target branch by doing the following:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  git fetch origin branch:mytargetbranch --depth 1
</code></pre></div>    </div>
  </li>
  <li>
    <p>You can also “unshallow” the clone, which fetches the whole Git history (and potentially
takes a long time / moves a lot of data) by using the <code class="highlighter-rouge">--unshallow</code> flag on the fetch:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  git fetch --unshallow origin
</code></pre></div>    </div>
  </li>
</ul>

                            <!-- tags -->
                            
                            <span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span
                                style="vertical-align: 2px"><a
                                    href="https://docs.docker.com/search/?q=automated">automated</a>, <a
                                    href="https://docs.docker.com/search/?q=build">build</a>, <a
                                    href="https://docs.docker.com/search/?q=images">images</a></span>
                            
                            
                            <div id="ratings-div"
                                style="color:#b9c2cc; text-align: center; margin-top: 150px;">
                                <div id="pd_rating_holder_8453675"></div>
                                <script type="text/javascript">
                                    PDRTJS_settings_8453675 = {
                                        "id": "8453675",
                                        "unique_id": "docker-hub/builds/advanced.md",
                                        "title": "Advanced options for Autobuild and Autotest",
                                        "permalink": "https://github.com/docker/docker.github.io/blob/oligarch/docker-hub/builds/advanced.md"
                                    };
                                    (function (d, c, j) {
                                        if (!document.getElementById(j)) {
                                            var pd = d.createElement(c),
                                                s;
                                            pd.id = j;
                                            pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
                                            s = document.getElementsByTagName(c)[0];
                                            s.parentNode.insertBefore(pd, s);
                                        }
                                    }(document, 'script', 'pd-rating-js'));
                                </script>
                            </div>
                            
                        </section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
    <ul class="nav jsTOCHorizontal hidden-md hidden-lg">
    </ul>
    <div class="divider hidden-md hidden-lg"></div>
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul>
                                        
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/docker-hub/builds/advanced.md"><i
                                                    class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/issues/new?body=ファイル: [docker-hub/builds/advanced.md](https://matsuand.github.io/docs.docker.jp.onthefly/docker-hub/builds/advanced/)"
                                                class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
                                        <!-- toggle mode -->
                                        <li>
                                            <div class="toggle-mode">
                                                <div class="icon">
                                                    <i class="fa fa-sun-o" aria-hidden="true"></i>
                                                </div>
                                                <div class="toggle-switch">
                                                    <label class="switch">
                                                        <input type="checkbox" id="switch-style">
                                                        <div class="slider round"></div>
                                                    </label>
                                                </div>
                                                <div class="icon">
                                                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                
                                
                                
                                <div id="side-toc-title">本ページ内:</div>
                                
<ul id="my_toc" class="inline_toc">
  <li><a href="#environment-variables-for-building-and-testing" class="nomunge">Environment variables for building and testing</a></li>
  <li><a href="#override-build-test-or-push-commands" class="nomunge">Override build, test or push commands</a></li>
  <li><a href="#custom-build-phase-hooks" class="nomunge">Custom build phase hooks</a>
    <ul>
      <li><a href="#build-hook-examples" class="nomunge">Build hook examples</a></li>
    </ul>
  </li>
  <li><a href="#source-repository--branch-clones" class="nomunge">Source Repository / Branch Clones</a></li>
</ul>


                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/why-docker">Why Docker?</a></b></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container?</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/overview">Products</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub">Docker Hub</a></li>
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Features</a></b></li>
                        <li><a href="https://www.docker.com/products/container-runtime">Container Runtime</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools">Developer Tools</a></li>
                        <li><a href="https://www.docker.com/products/kubernetes">Kubernetes</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Developers</a></b></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/play-with-docker">Play with Docker</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/open-source">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank">Company</a></b></li>
                        <li><a href="https://www.docker.com/company">About Us</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank">Blog</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners">Partners</a></li>
                        <li><a href="https://www.docker.com/company/newsroom">Newsroom</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2020 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/github.css">
    
    <script>var pageURL = "/docker-hub/builds/advanced/";</script>
    <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/menu.js"></script>
    <script src="/docs.docker.jp.onthefly/js/jquery.js"></script>
    <script src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
    <script src="/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/metadata.js"></script>
    <script src="/docs.docker.jp.onthefly/js/glossary.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/toc.js"></script>
    <script defer src="/js/search.js"></script>
</body>


</html>
