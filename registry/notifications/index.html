<!-- Page generated 2020-07-16 21:49:37 +0900 -->
<!-- Logic for 'edit this button'


    

    

    

    

    

    

    

    

-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style type="text/css">
      @charset "UTF-8";
      [ng\:cloak],
      [ng-cloak],
      [data-ng-cloak],
      [x-ng-cloak],
      .ng-cloak,
      .x-ng-cloak,
      .ng-hide:not(.ng-hide-animate) {
          display: none !important;
      }

      ng\:form {
          display: block;
      }
  </style>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WL2QLG5');</script>

  
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta name="msapplication-TileImage" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico">
  <link rel="apple-touch-icon" type="image/x-icon" href="/docs.docker.jp.onthefly/favicons/docs@2x.ico" sizes="129x128">
  <meta property="og:image" content="/docs.docker.jp.onthefly/favicons/docs@2x.ico"/>
  <!-- metadata -->
  <meta property="og:type" content="website"/>
  <meta property="og:updated_time" itemprop="dateUpdated" content="2020-07-16T21:49:37+09:00"/>
  <meta property="og:image" itemprop="image primaryImageOfPage" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:domain" content="docs.docker.com"/>
  <meta name="twitter:site" content="@docker_docs"/>
  <meta name="twitter:url" content="https://twitter.com/docker_docs"/>
  <meta name="twitter:title" itemprop="title name" content="Work with notifications"/>
  <meta name="twitter:description" property="og:description" itemprop="description" content="このページでは、オープンソースである Docker Registry を使って、独自にレジストリを提供するための情報を示しています。 Docker Hub は、提供するレジストリにさまざまな機能を追加することができます。 たとえばチーム、組織、ウェブフック、自動ビルドなどです。 詳しくは Docker Hub を参照してください。 The Registry supports sending webhook notifications in response to events happening within the registry. Notifications are sent in..." />
  <meta name="twitter:image:src" content="/docs.docker.jp.onthefly/images/docs@2x.png"/>
  <meta name="twitter:image:alt" content="Docker ドキュメント"/>
  <meta property="article:published_time" itemprop="datePublished" content="2020-07-16T21:49:37+09:00"/>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="registry, on-prem, images, tags, repository, distribution, notifications, advanced">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/font-awesome.min.css">
  <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/bootstrap.min.css">
  <link id="pygments" rel="stylesheet" href="/docs.docker.jp.onthefly/css/pygments/perldoc.css">
  <link id="pagestyle" rel="stylesheet" href="/docs.docker.jp.onthefly/css/style.css">

  <!-- Go get "Open Sans" font from Google -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <!-- SEO stuff -->
  <title>Work with notifications | Docker ドキュメント</title>
  <meta property="og:title" content="Work with notifications" />
  <meta property="og:locale" content="ja_JP" />
  <meta name="description" content="Explains how to work with registry notifications" />
  <meta property="og:description" content="Explains how to work with registry notifications" />
  <link rel="canonical" href="/registry/notifications/" />
  <meta property="og:url" content="https://docs.docker.com/registry/notifications/" />
  <meta property="og:site_name" content="Docker ドキュメント" />
  <script type="application/ld+json">{"@context":"http://schema.org","@type":"WebPage","headline":"Work with notifications","description":"Explains how to work with registry notifications","url":"https://docs.docker.com/registry/notifications/"}</script>
  <!-- END SEO STUFF -->
  
</head>


    <body ng-app="Docker" ng-controller="DockerController" class="colums">
    <header>
        <nav class="nav-secondary navbar navbar-fixed-top">
    <!-- <div class="fan"></div> -->
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="/docs.docker.jp.onthefly/">
                <img class="logo" src="/docs.docker.jp.onthefly/images/docker-docs-logo.svg" alt="Docker Docs" title="Docker Docs">
            </a>
        </div>
        <div class="navbar-collapse" aria-expanded="false" style="height: 1px;">
            <div class="logo-mobile">
    <a href="/docs.docker.jp.onthefly/">
        <img src="/docs.docker.jp.onthefly/images/docker-icon.svg" alt="Docker Docs" title="Docker Docs">
    </a>
</div>
<div class="search-form" id="search-div">
    <form class="search-form form-inline ng-pristine ng-valid" id="searchForm" action="/docs.docker.jp.onthefly/search/">
        <input class="search-field form-control ds-input" id="st-search-input" value="" name="q" placeholder="文書内検索" type="search" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top;">
        <div id="autocompleteContainer">
            <div id="autocompleteResults"></div>
        </div>
        <!-- <button type="submit" class="search-submit btn btn-default">検索</button> -->
    </form>
</div>
<div class="sidebar-toggle">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
    </button>
</div>
<div class="nav-container hidden-sm hidden-xs">
    <div id="tabs">
        <ul class="tabs jsTOCHorizontal">

        </ul>
    </div>
    <div class="ctrl-right">
        <a href="javascript:void(0)" id="menu-toggle"><i class="fa fa-indent" aria-hidden="true"></i></a>
    </div>
</div>

        </div>
    </div>
</nav>

    </header>
    <div class="wrapper right-open">
        <div class="container-fluid">
            <div class="row">
                <div class="col-body">
                    <main class="col-content content">
                        <section class="section">
                            
                            
                            <h1>Work with notifications</h1> 
                            <span class="reading-time" title="Estimated reading time">
  <span class="reading-time-label">読む時間の目安: </span>
  
  
    11 分
  
</span>

                            
                            <!-- This text will be included in the Docker Registry docs -->

<blockquote class="important">

  <p>このページでは、オープンソースである Docker Registry を使って、独自にレジストリを提供するための情報を示しています。
Docker Hub は、提供するレジストリにさまざまな機能を追加することができます。
たとえばチーム、組織、ウェブフック、自動ビルドなどです。
詳しくは <a href="/docker-hub/">Docker Hub</a> を参照してください。</p>
</blockquote>

<p>The Registry supports sending webhook notifications in response to events
happening within the registry. Notifications are sent in response to manifest
pushes and pulls and layer pushes and pulls. These actions are serialized into
events. The events are queued into a registry-internal broadcast system which
queues and dispatches events to <a href="/docs.docker.jp.onthefly/registry/notifications/#endpoints"><em>Endpoints</em></a>.</p>

<p><img src="/docs.docker.jp.onthefly/registry/images/notifications.png" alt="Workflow of registry notifications" /></p>

<h2 id="endpoints">Endpoints</h2>

<p>Notifications are sent to <em>endpoints</em> via HTTP requests. Each configured
endpoint has isolated queues, retry configuration and http targets within each
instance of a registry. When an action happens within the registry, it is
converted into an event which is dropped into an inmemory queue. When the
event reaches the end of the queue, an http request is made to the endpoint
until the request succeeds. The events are sent serially to each endpoint but
order is not guaranteed.</p>

<h2 id="configuration">Configuration</h2>

<p>To setup a registry instance to send notifications to endpoints, one must add
them to the configuration. A simple example follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  notifications:
    endpoints:
      - name: alistener
        url: https://mylistener.example.com/event
        headers:
          Authorization: [Bearer &lt;your token, if needed&gt;]
        timeout: 500ms
        threshold: 5
        backoff: 1s
</code></pre></div></div>

<p>The above would configure the registry with an endpoint to send events to
<code class="highlighter-rouge">https://mylistener.example.com/event</code>, with the header “Authorization: Bearer
&lt;your token, if needed&gt;”. The request would timeout after 500 milliseconds. If
5 failures happen consecutively, the registry backs off for 1 second before
trying again.</p>

<p>For details on the fields, see the <a href="/docs.docker.jp.onthefly/registry/configuration/#notifications">configuration documentation</a>.</p>

<p>A properly configured endpoint should lead to a log message from the registry
upon startup:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>INFO[0000] configuring endpoint alistener (https://mylistener.example.com/event), timeout=500ms, headers=map[Authorization:[Bearer &lt;your token if needed&gt;]]  app.id=812bfeb2-62d6-43cf-b0c6-152f541618a3 environment=development service=registry
</code></pre></div></div>

<h2 id="events">Events</h2>

<p>Events have a well-defined JSON structure and are sent as the body of
notification requests. One or more events are sent in a structure called an
envelope. Each event has a unique ID that can be used to uniquely identify incoming
requests, if required. Along with that, an <em>action</em> is provided with a
<em>target</em>, identifying the object mutated during the event.</p>

<p>The fields available in an <code class="highlighter-rouge">event</code> are described below.</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>id</td>
      <td>string</td>
      <td>ID provides a unique identifier for the event.</td>
    </tr>
    <tr>
      <td>timestamp</td>
      <td>Time</td>
      <td>Timestamp is the time at which the event occurred.</td>
    </tr>
    <tr>
      <td>action</td>
      <td>string</td>
      <td>Action indicates what action encompasses the provided event.</td>
    </tr>
    <tr>
      <td>target</td>
      <td>distribution.Descriptor</td>
      <td>Target uniquely describes the target of the event.</td>
    </tr>
    <tr>
      <td>length</td>
      <td>int</td>
      <td>Length in bytes of content. Same as Size field in Descriptor.</td>
    </tr>
    <tr>
      <td>repository</td>
      <td>string</td>
      <td>Repository identifies the named repository.</td>
    </tr>
    <tr>
      <td>fromRepository</td>
      <td>string</td>
      <td>FromRepository identifies the named repository which a blob was mounted from if appropriate.</td>
    </tr>
    <tr>
      <td>url</td>
      <td>string</td>
      <td>URL provides a direct link to the content.</td>
    </tr>
    <tr>
      <td>tag</td>
      <td>string</td>
      <td>Tag identifies a tag name in tag events.</td>
    </tr>
    <tr>
      <td>request</td>
      <td><a href="https://godoc.org/github.com/docker/distribution/notifications#RequestRecord">RequestRecord</a></td>
      <td>Request covers the request that generated the event.</td>
    </tr>
    <tr>
      <td>actor</td>
      <td><a href="https://godoc.org/github.com/docker/distribution/notifications#ActorRecord">ActorRecord</a>.</td>
      <td>Actor specifies the agent that initiated the event. For most situations, this could be from the authorization context of the request.</td>
    </tr>
    <tr>
      <td>source</td>
      <td><a href="https://godoc.org/github.com/docker/distribution/notifications#SourceRecord">SourceRecord</a></td>
      <td>Source identifies the registry node that generated the event. Put differently, while the actor “initiates” the event, the source “generates” it.</td>
    </tr>
  </tbody>
</table>

<p>The following is an example of a JSON event, sent in response to the pull of a
manifest:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="s2">"events"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"320678d8-ca14-430f-8bb6-4ca139cd83f7"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2016-03-09T14:44:26.402973972-08:00"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"pull"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">708</span><span class="p">,</span><span class="w">
            </span><span class="s2">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:fea8895f450959fa676bcc1df0611ea93823a735a01205fd8622846041d0c7cf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">708</span><span class="p">,</span><span class="w">
            </span><span class="s2">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hello-world"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://192.168.100.227:5000/v2/hello-world/manifests/sha256:fea8895f450959fa676bcc1df0611ea93823a735a01205fd8622846041d0c7cf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"tag"</span><span class="p">:</span><span class="w"> </span><span class="s2">"latest"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6df24a34-0959-4923-81ca-14f09767db19"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.64.11:42961"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192.168.100.227:5000"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"useragent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"curl/7.38.0"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"actor"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
         </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"xtal.local:5000"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"instanceID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a53db899-3b4b-4a62-a067-8dd013beaca4"</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The target struct of events which are sent when manifests and blobs are deleted
contains a subset of the data contained in Get and Put events. Specifically,
only the digest and repository are sent.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:d89e1bee20d9cb344674e213b581f14fbd8e70274ecf9d10c514bab78a307845"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"library/test"</span><span class="w">
</span><span class="p">},</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p><strong>Note</strong>: As of version 2.1, the <code class="highlighter-rouge">length</code> field for event targets
is being deprecated for the <code class="highlighter-rouge">size</code> field, bringing the target in line with
common nomenclature. Both will continue to be set for the foreseeable
future. Newer code should favor <code class="highlighter-rouge">size</code> but accept either.</p>
</blockquote>

<h2 id="envelope">Envelope</h2>

<p>The envelope contains one or more events, with the following json structure:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="s2">"events"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">...</span><span class="w"> </span><span class="p">],</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>While events may be sent in the same envelope, the set of events within that
envelope have no implied relationship. For example, the registry may choose to
group unrelated events and send them in the same envelope to reduce the total
number of requests.</p>

<p>The full package has the mediatype
“application/vnd.docker.distribution.events.v1+json”, which is set on the
request coming to an endpoint.</p>

<p>An example of a full event may look as follows:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/callback</span><span class="w">
</span><span class="err">Host</span><span class="p">:</span><span class="w"> </span><span class="err">application/vnd.docker.distribution.events.v</span><span class="mi">1</span><span class="err">+json</span><span class="w">
</span><span class="err">Authorization</span><span class="p">:</span><span class="w"> </span><span class="err">Bearer</span><span class="w"> </span><span class="err">&lt;your</span><span class="w"> </span><span class="err">token</span><span class="p">,</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="err">needed&gt;</span><span class="w">
</span><span class="err">Content-Type</span><span class="p">:</span><span class="w"> </span><span class="err">application/vnd.docker.distribution.events.v</span><span class="mi">1</span><span class="err">+json</span><span class="w">

</span><span class="p">{</span><span class="w">
   </span><span class="s2">"events"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdf-asdf-asdf-asdf-0"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2006-01-02T15:04:05Z"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"push"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v1+json"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
            </span><span class="s2">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:fea8895f450959fa676bcc1df0611ea93823a735a01205fd8622846041d0c7cf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"library/test"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/v2/library/test/manifests/sha256:c3b3692957d439ac1928219a83fac91e7bf96c153725526874673ae1f2023f8d5"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdfasdf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"registrycluster.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"useragent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test/0.1"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"actor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-actor"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hostname.local:port"</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdf-asdf-asdf-asdf-1"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2006-01-02T15:04:05Z"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"push"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.container.image.rootfs.diff+x-gtar"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
            </span><span class="s2">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:c3b3692957d439ac1928219a83fac91e7bf96c153725526874673ae1f2023f8d5"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"library/test"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/v2/library/test/blobs/sha256:c3b3692957d439ac1928219a83fac91e7bf96c153725526874673ae1f2023f8d5"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdfasdf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"registrycluster.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"useragent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test/0.1"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"actor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-actor"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hostname.local:port"</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdf-asdf-asdf-asdf-2"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"timestamp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2006-01-02T15:04:05Z"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"push"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"target"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.container.image.rootfs.diff+x-gtar"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"length"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
            </span><span class="s2">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:c3b3692957d439ac1928219a83fac91e7bf96c153725526874673ae1f2023f8d5"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"repository"</span><span class="p">:</span><span class="w"> </span><span class="s2">"library/test"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.com/v2/library/test/blobs/sha256:c3b3692957d439ac1928219a83fac91e7bf96c153725526874673ae1f2023f8d5"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asdfasdf"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"registrycluster.local"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PUT"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"useragent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test/0.1"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"actor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-actor"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"addr"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hostname.local:port"</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="responses">Responses</h2>

<p>The registry is fairly accepting of the response codes from endpoints. If an
endpoint responds with any 2xx or 3xx response code (after following
redirects), the message is considered to have been delivered, and is discarded.</p>

<p>In turn, it is recommended that endpoints are accepting of incoming responses,
as well. While the format of event envelopes are standardized by media type,
any “pickyness” about validation may cause the queue to backup on the
registry.</p>

<h2 id="monitoring">Monitoring</h2>

<p>The state of the endpoints are reported via the debug/vars http interface,
usually configured to <code class="highlighter-rouge">http://localhost:5001/debug/vars</code>. Information such as
configuration and metrics are available by endpoint.</p>

<p>The following provides an example of a few endpoints that have experienced
several failures and have since recovered:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"notifications"</span><span class="p">:{</span><span class="w">
   </span><span class="s2">"endpoints"</span><span class="p">:[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"name"</span><span class="p">:</span><span class="s2">"local-5003"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"url"</span><span class="p">:</span><span class="s2">"http://localhost:5003/callback"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Headers"</span><span class="p">:{</span><span class="w">
            </span><span class="s2">"Authorization"</span><span class="p">:[</span><span class="w">
               </span><span class="s2">"Bearer </span><span class="se">\u</span><span class="s2">003can example token</span><span class="se">\u</span><span class="s2">003e"</span><span class="w">
            </span><span class="p">]</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="s2">"Timeout"</span><span class="p">:</span><span class="mi">1000000000</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Threshold"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Backoff"</span><span class="p">:</span><span class="mi">1000000000</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Metrics"</span><span class="p">:{</span><span class="w">
            </span><span class="s2">"Pending"</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Events"</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Successes"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Failures"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Errors"</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Statuses"</span><span class="p">:{</span><span class="w">

            </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="s2">"name"</span><span class="p">:</span><span class="s2">"local-8083"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"url"</span><span class="p">:</span><span class="s2">"http://localhost:8083/callback"</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Headers"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Timeout"</span><span class="p">:</span><span class="mi">1000000000</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Threshold"</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Backoff"</span><span class="p">:</span><span class="mi">1000000000</span><span class="p">,</span><span class="w">
         </span><span class="s2">"Metrics"</span><span class="p">:{</span><span class="w">
            </span><span class="s2">"Pending"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Events"</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Successes"</span><span class="p">:</span><span class="mi">76</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Failures"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Errors"</span><span class="p">:</span><span class="mi">28</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Statuses"</span><span class="p">:{</span><span class="w">
               </span><span class="s2">"202 Accepted"</span><span class="p">:</span><span class="mi">76</span><span class="w">
            </span><span class="p">}</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>If using notification as part of a larger application, it is <em>critical</em> to
monitor the size (“Pending” above) of the endpoint queues. If failures or
queue sizes are increasing, it can indicate a larger problem.</p>

<p>The logs are also a valuable resource for monitoring problems. A failing
endpoint leads to messages similar to the following:</p>

<pre><code class="language-none">ERRO[0340] retryingsink: error writing events: httpSink{http://localhost:5003/callback}: error posting: Post http://localhost:5003/callback: dial tcp 127.0.0.1:5003: connection refused, retrying
WARN[0340] httpSink{http://localhost:5003/callback} encountered too many errors, backing off
</code></pre>

<p>The above indicates that several errors caused a backoff and the registry
waits before retrying.</p>

<h2 id="considerations">Considerations</h2>

<p>Currently, the queues are inmemory, so endpoints should be <em>reasonably
reliable</em>. They are designed to make a best-effort to send the messages but if
an instance is lost, messages may be dropped. If an endpoint goes down, care
should be taken to ensure that the registry instance is not terminated before
the endpoint comes back up or messages are lost.</p>

<p>This can be mitigated by running endpoints in close proximity to the registry
instances. One could run an endpoint that pages to disk and then forwards a
request to provide better durability.</p>

<p>The notification system is designed around a series of interchangeable <em>sinks</em>
which can be wired up to achieve interesting behavior. If this system doesn’t
provide acceptable guarantees, adding a transactional <code class="highlighter-rouge">Sink</code> to the registry
is a possibility, although it may have an effect on request service time.
See the
<a href="http://godoc.org/github.com/docker/distribution/notifications#Sink">godoc</a>
for more information.</p>

                            <!-- tags -->
                            
                            <span class="glyphicon glyphicon-tags" style="padding-right: 10px"></span><span
                                style="vertical-align: 2px"><a
                                    href="https://docs.docker.com/search/?q=registry">registry</a>, <a
                                    href="https://docs.docker.com/search/?q=on-prem">on-prem</a>, <a
                                    href="https://docs.docker.com/search/?q=images">images</a>, <a
                                    href="https://docs.docker.com/search/?q=tags">tags</a>, <a
                                    href="https://docs.docker.com/search/?q=repository">repository</a>, <a
                                    href="https://docs.docker.com/search/?q=distribution">distribution</a>, <a
                                    href="https://docs.docker.com/search/?q=notifications">notifications</a>, <a
                                    href="https://docs.docker.com/search/?q=advanced">advanced</a></span>
                            
                            
                            <div id="ratings-div"
                                style="color:#b9c2cc; text-align: center; margin-top: 150px;">
                                <div id="pd_rating_holder_8453675"></div>
                                <script type="text/javascript">
                                    PDRTJS_settings_8453675 = {
                                        "id": "8453675",
                                        "unique_id": "registry/notifications.md",
                                        "title": "Work with notifications",
                                        "permalink": "https://github.com/docker/docker.github.io/blob/oligarch/registry/notifications.md"
                                    };
                                    (function (d, c, j) {
                                        if (!document.getElementById(j)) {
                                            var pd = d.createElement(c),
                                                s;
                                            pd.id = j;
                                            pd.src = ('https:' == document.location.protocol) ? 'https://polldaddy.com/js/rating/rating.js' : 'http://i0.poll.fm/js/rating/rating.js';
                                            s = document.getElementsByTagName(c)[0];
                                            s.parentNode.insertBefore(pd, s);
                                        }
                                    }(document, 'script', 'pd-rating-js'));
                                </script>
                            </div>
                            
                        </section>
                    </main>
                    <nav class="col-nav">
                        <div id="sidebar-nav" class="sidebar hidden-sm hidden-xs">
                            <div id="navbar" class="nav-sidebar">
    <ul class="nav jsTOCHorizontal hidden-md hidden-lg">
    </ul>
    <div class="divider hidden-md hidden-lg"></div>
    <ul class="nav" id="jsTOCLeftNav">
    </ul>
</div>

                        </div>
                    </nav>
                    <div class="col-toc">
                        <div class="sidebar hidden-xs hidden-sm">
                            <div class="toc-nav">
                                <div class="feedback-links">
                                    <ul>
                                        
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/edit/v19.03.local/registry/notifications.md"><i
                                                    class="fa fa-pencil-square-o" aria-hidden="true"></i> このページの編集</a></li>
                                        <li><a href="https://github.com/matsuand/docs.docker.jp/issues/new?body=ファイル: [registry/notifications.md](https://matsuand.github.io/docs.docker.jp.onthefly/registry/notifications/)"
                                                class="nomunge"><i class="fa fa-check" aria-hidden="true"></i> 文書変更のリクエスト</a></li>
                                        <!-- toggle mode -->
                                        <li>
                                            <div class="toggle-mode">
                                                <div class="icon">
                                                    <i class="fa fa-sun-o" aria-hidden="true"></i>
                                                </div>
                                                <div class="toggle-switch">
                                                    <label class="switch">
                                                        <input type="checkbox" id="switch-style">
                                                        <div class="slider round"></div>
                                                    </label>
                                                </div>
                                                <div class="icon">
                                                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                
                                
                                
                                <div id="side-toc-title">本ページ内:</div>
                                
<ul id="my_toc" class="inline_toc">
  <li><a href="#endpoints" class="nomunge">Endpoints</a></li>
  <li><a href="#configuration" class="nomunge">Configuration</a></li>
  <li><a href="#events" class="nomunge">Events</a></li>
  <li><a href="#envelope" class="nomunge">Envelope</a></li>
  <li><a href="#responses" class="nomunge">Responses</a></li>
  <li><a href="#monitoring" class="nomunge">Monitoring</a></li>
  <li><a href="#considerations" class="nomunge">Considerations</a></li>
</ul>


                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <footer class="footer">
          
    <div class="container">
        <div class="top_footer">
            <div class="row">
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/why-docker">Why Docker?</a></b></li>
                        <li><a href="https://www.docker.com/what-container">What is a Container?</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/overview">Products</a></b></li>
                        <li><a href="https://www.docker.com/products/docker-desktop">Docker Desktop</a></li>
                        <li><a href="https://www.docker.com/products/docker-hub">Docker Hub</a></li>
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Features</a></b></li>
                        <li><a href="https://www.docker.com/products/container-runtime">Container Runtime</a></li>
                        <li><a href="https://www.docker.com/products/developer-tools">Developer Tools</a></li>
                        <li><a href="https://www.docker.com/products/kubernetes">Kubernetes</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/products/docker-desktop">Developers</a></b></li>
                        <li><a href="https://www.docker.com/use-cases">Use Cases</a></li>
                        <li><a href="https://www.docker.com/play-with-docker">Play with Docker</a></li>
                        <li><a href="https://www.docker.com/docker-community">Community</a></li>
                        <li><a href="https://www.docker.com/open-source">Open Source</a></li>
                        <li><a href="https://www.docker.com/community/docker-captains">Docker Captains</a></li>
                    </ul>
                </div>
                <div class="col-xs-12 col-sm-3 col-md-3">
                    <ul class="footer_links">
                        <li><b><a href="https://www.docker.com/company" target="_blank">Company</a></b></li>
                        <li><a href="https://www.docker.com/company">About Us</a></li>
                        <li><a href="https://www.docker.com/blog/" target="_blank">Blog</a></li>
                        <li><a href="https://www.docker.com/customers">Customers</a></li>
                        <li><a href="https://www.docker.com/partners">Partners</a></li>
                        <li><a href="https://www.docker.com/company/newsroom">Newsroom</a></li>
                        <li><a href="https://www.docker.com/careers">Careers</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact Us</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-nav">
                <nav class="footer_sub_nav">
                    <ul class="menu">
                        <li><a href="http://status.docker.com/">Status</a></li>
                        <li><a href="https://www.docker.com/docker-security">Security</a></li>
                        <li><a href="https://www.docker.com/legal">Legal</a></li>
                        <li><a href="https://www.docker.com/company/contact">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="bottom_footer">
            <div class="footer-copyright col-xs-12 col-md-8">
                <p class="copyright">
                    Copyright &copy; 2013-2020 Docker Inc. All rights reserved. </p>
            </div>
            <div class="footer_social_nav">
                <ul class="nav-social">
                    <li class="fa fa-twitter"><a href="http://twitter.com/docker">Twitter</a></li>
                    <li class="fa fa-youtube"><a href="http://www.youtube.com/user/dockerrun">Youtube</a></li>
                    <li class="fa fa-github"><a href="https://github.com/docker">GitHub</a></li>
                    <li class="fa fa-linkedin"><a href="https://www.linkedin.com/company/docker">Linkedin</a></li>
                    <li class="fa fa-facebook"><a href="https://www.facebook.com/docker.run">Facebook</a></li>
                    <li class="fa fa-slideshare"><a href="https://www.slideshare.net/docker">Slideshare</a></li>
                    <li class="fa fa-reddit"><a href="https://www.reddit.com/r/docker">Reddit</a></li>
                </ul>
            </div>
        </div>
    </div>

    </footer>
    <link rel="stylesheet" href="/docs.docker.jp.onthefly/css/github.css">
    
    <script>var pageURL = "/registry/notifications/";</script>
    <script defer src="/docs.docker.jp.onthefly/js/anchorlinks.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/menu.js"></script>
    <script src="/docs.docker.jp.onthefly/js/jquery.js"></script>
    <script src="/docs.docker.jp.onthefly/js/bootstrap.min.js"></script>
    <script src="/docs.docker.jp.onthefly/js/stickyfill.min.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/metadata.js"></script>
    <script src="/docs.docker.jp.onthefly/js/glossary.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/docs.js"></script>
    <script defer src="/docs.docker.jp.onthefly/js/toc.js"></script>
    <script defer src="/js/search.js"></script>
</body>


</html>
